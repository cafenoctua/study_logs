# =============================================================================
# dbt Selectors 設定
# =============================================================================
# 参考: https://docs.getdbt.com/reference/node-selection/yaml-selectors
#
# 使い方:
#   dbt build --selector <selector_name>
#   dbt ls --selector <selector_name>  # 対象モデルを事前確認
#
# =============================================================================
#
# CI戦略（state:modified）について:
# CIでは state:modified を使って変更されたモデルのみをビルドします。
# mainブランチのmanifest.jsonをArtifactとして保存し、PRブランチで比較します。
#
# 実行例:
#   dbt build --select state:modified+ --state ./prod_state --exclude package:dbt_project_evaluator
#
# =============================================================================

selectors:
  # ===========================================================================
  # CI/CD 用セレクター
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # ci_slim: Slim CI（state:modifiedで変更分のみビルド）
  # ---------------------------------------------------------------------------
  # 注意: このセレクターを使う場合は --state オプションも必要
  # 例: dbt build --selector ci_slim --state ./prod_state
  - name: ci_slim
    description: |
      CI用: 変更されたモデルとその下流のみをビルド。
      --state オプションと組み合わせて使用。
      dbt_project_evaluatorは除外（別途実行）。
    definition:
      intersection:
        - method: state
          value: modified
          children: true
        - exclude:
            - method: package
              value: dbt_project_evaluator

  # ---------------------------------------------------------------------------
  # ci_full: CI用フルビルド（evaluator除外）
  # ---------------------------------------------------------------------------
  - name: ci_full
    description: |
      CI用: 全モデルをビルド（dbt_project_evaluator除外）。
    definition:
      intersection:
        - method: fqn
          value: "*"
        - exclude:
            - method: package
              value: dbt_project_evaluator

  # ---------------------------------------------------------------------------
  # evaluator: dbt_project_evaluator のみ実行
  # ---------------------------------------------------------------------------
  - name: evaluator
    description: |
      構造解析: dbt_project_evaluatorパッケージのみを実行。
      DAG構造、命名規則、ドキュメントカバレッジ等をチェック。
    definition:
      method: package
      value: dbt_project_evaluator

  # ===========================================================================
  # ローカル開発用セレクター
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # dev_wip: WIPタグ付きモデルのみ
  # ---------------------------------------------------------------------------
  - name: dev_wip
    description: |
      開発用: tag:wipが付いたモデルとその下流のみを実行。
    definition:
      intersection:
        - method: tag
          value: wip
          children: true
        - exclude:
            - method: package
              value: dbt_project_evaluator

  # ---------------------------------------------------------------------------
  # dev_full: ローカルでのフルビルド
  # ---------------------------------------------------------------------------
  - name: dev_full
    description: |
      開発用: プロジェクト全体をビルド（evaluator除外）。
    definition:
      intersection:
        - method: fqn
          value: "*"
        - exclude:
            - method: package
              value: dbt_project_evaluator

  # ===========================================================================
  # 本番デプロイ用セレクター
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # prod_full: 本番フルビルド
  # ---------------------------------------------------------------------------
  - name: prod_full
    description: |
      本番用: プロジェクト全体をビルド（evaluator除外）。
    definition:
      intersection:
        - method: fqn
          value: "*"
        - exclude:
            - method: package
              value: dbt_project_evaluator

  # ---------------------------------------------------------------------------
  # prod_incremental: 本番増分更新
  # ---------------------------------------------------------------------------
  - name: prod_incremental
    description: |
      本番用: 増分テーブルのみ更新。
    definition:
      intersection:
        - method: config
          value: "materialized:incremental"
        - exclude:
            - method: package
              value: dbt_project_evaluator

  # ===========================================================================
  # レイヤー別セレクター
  # ===========================================================================

  - name: layer_staging
    description: |
      レイヤー別: stagingモデルのみ実行。
    definition:
      method: path
      value: models/staging

  - name: layer_marts
    description: |
      レイヤー別: martsモデルのみ実行。
    definition:
      method: path
      value: models/marts

  # ===========================================================================
  # テスト用セレクター
  # ===========================================================================

  - name: unit_tests
    description: |
      テスト用: ユニットテストのみ実行。
    definition:
      method: test_type
      value: unit
